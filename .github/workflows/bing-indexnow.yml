name: Submit to Bing IndexNow

on:
  push:
    branches: ["main"]
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  submit-to-bing:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies (jq)
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Wait for 1 minute (only on push to main)
        if: github.event_name == 'push' # 仅push触发时等待，节省时长
        run: sleep 60

      - name: Fetch sitemap and submit to Bing IndexNow
        run: |
          # 配置参数
          HOST="jackie.openenet.cn"
          API_KEY="98a318ce9ac24028a209c3e93b1e1aa6"
          KEY_LOCATION="https://jackie.openenet.cn/98a318ce9ac24028a209c3e93b1e1aa6.txt"
          SITEMAP_URL="https://jackie.openenet.cn/sitemap.txt"

          # 1. 下载sitemap.txt
          echo "=== 下载sitemap.txt ==="
          if ! curl -s "$SITEMAP_URL" -o sitemap.txt; then
            echo "❌ 错误：无法下载sitemap.txt"
            exit 1
          fi

          # 2. 处理URL
          echo -e "\n=== 处理URL列表 ==="
          grep -v '^$' sitemap.txt | sort -u | grep "^https://$HOST/" > valid_urls.txt
          if [ ! -s valid_urls.txt ]; then
            echo "❌ 错误：无有效URL"
            exit 1
          fi
          echo "✅ 有效URL数量：$(wc -l < valid_urls.txt)"

          # 3. 构造JSON
          echo -e "\n=== 构造JSON请求数据 ==="
          URL_LIST=$(jq -R -s -c 'split("\n") | map(select(length > 0))' valid_urls.txt)
          JSON_DATA=$(jq -n \
            --arg host "$HOST" \
            --arg key "$API_KEY" \
            --arg keyLocation "$KEY_LOCATION" \
            --argjson urlList "$URL_LIST" \
            '{host: $host, key: $key, keyLocation: $keyLocation, urlList: $urlList}')

          # 4. 提交到Bing API（核心修改：移除--fail，保留状态码）
          echo -e "\n=== 提交到Bing IndexNow ==="
          # 捕获HTTP状态码和响应内容
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA" \
            "https://www.bing.com/indexnow?url=https://$HOST&key=$API_KEY")
          
          # 分离响应内容和状态码
          HTTP_STATUS=$(echo "$RESPONSE" | grep -oP 'HTTP_STATUS:\K\d+' | tail -1)
          API_RESPONSE=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')

          # 5. 修正成功判断逻辑（核心修复）
          echo "Bing API 状态码：$HTTP_STATUS"
          echo "Bing API 响应：$API_RESPONSE"
          
          # 成功条件：状态码200/202，或响应包含success/jobId（Bing的成功标识）
          if [[ $HTTP_STATUS =~ ^20[02]$ ]] || echo "$API_RESPONSE" | grep -qE '"success":true|"jobId"'; then
            echo -e "\n✅ 成功：URL提交到Bing IndexNow（状态码：$HTTP_STATUS）"
          else
            echo -e "\n❌ 失败：提交失败（状态码：$HTTP_STATUS）"
            exit 1
          fi